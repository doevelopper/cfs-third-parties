stages:
    - dependencies
    - compile
    - test
    - target-package
    - target-install
    - deploy
    - target-clean

# Cache in between builds
cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
        - ${CI_PROJECT_DIR}/devslibs
        - compilers
        - vendor/ruby

uncrustify:
    stage: dependencies

    before_script:
        - echo "Only when AArch64 is true"
        - date -u

    script:
        - cmake --version
        - git clone --depth=1 https://github.com/uncrustify/uncrustify.git
        - cd uncrustify
        - cmake -E make_directory build
        - cmake -E chdir build -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/devslibs ..
        - cmake --build build --target all --clean-first -- -j$(nproc)
        - cmake --build build --target install
        - cd ..

    after_script:
        - date -u

    tags:
        - agent-smith

#    only:
#        variables:
#            - ${BOOTSTRAP}

    artifacts:
        paths:
            - ${CI_PROJECT_DIR}/devslibs

apache:

    stage: dependencies

    before_script:
        - echo "Only when AArch64 is true"
        - date -u

    script:
        - echo "Building Apache Runtime Library"
        - wget --quiet https://www-us.apache.org/dist/apr/apr-1.6.5.tar.gz
        - tar -xvzf apr-1.6.5.tar.gz > /dev/null
        - cd apr-1.6.5
        - ./configure --prefix=${CI_PROJECT_DIR}/devslibs --enable-threads --enable-posix-shm 
            --enable-allocator-guard-pages --enable-pool-concurrency-check --enable-other-child
        - make clean && make && make install
        - cd ..

        - echo "Building Expat Library"
        - git clone --depth=1 https://github.com/libexpat/libexpat.git
        - cd libexpat/expat
        - cmake -E make_directory build
        - cmake -E chdir build cmake .. -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/devslibs -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        - cmake --build build --target all --clean-first
        - cmake --build build --target install
        - cd ..

        - echo "Building Apache Runtime Utils Library"
        - wget --quiet https://www-us.apache.org/dist//apr/apr-util-1.6.1.tar.gz
        - tar -xvf apr-util-1.6.1.tar.gz > /dev/null
        - cd apr-util-1.6.1
        - ./configure --prefix=${CI_PROJECT_DIR}/devslibs --with-apr=${CI_PROJECT_DIR}/devslibs 
        - make clean && make && make install
        - cd ..

        - echo "Building Apache logging library Log4cxx"
        - git clone --depth=1 https://git-wip-us.apache.org/repos/asf/logging-log4cxx.git
        - cd logging-log4cxx
        - ./autogen.sh
        - ./configure --prefix=${CI_PROJECT_DIR}/devslibs --with-apr=${CI_PROJECT_DIR}/devslibs 
            --with-apr-util=devslibs --with-ODBC=no --with-SMTP=no 
            --enable-char --enable-wchar_t 
            --with-charset=utf-8 --with-logchar=utf-8
        - make clean && make && make install
        - cd ..

    tags:
        - agent-smith

#    only:
    after_script:
        - date -u

    artifacts:
        paths:
            - ${CI_PROJECT_DIR}/devslibs
